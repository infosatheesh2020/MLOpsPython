# Pipeline template that attempts to get the latest model version and adds it to the environment for subsequent tasks to use.
steps:
- task: AzureCLI@1
  displayName: 'Install AzureML CLI'
  inputs:
    azureSubscription: '$(WORKSPACE_SVC_CONNECTION)'
    scriptLocation: inlineScript
    workingDirectory: $(Build.SourcesDirectory)
    inlineScript: 'az extension add -n azure-cli-ml'
- task: AzureCLI@1
  inputs:
    azureSubscription: '$(WORKSPACE_SVC_CONNECTION)'
    scriptLocation: inlineScript
    workingDirectory: $(Build.SourcesDirectory)
    inlineScript: |
      set -e # fail on error
      FOUND_MODEL=$(az ml model list -g $(RESOURCE_GROUP) --workspace-name $(WORKSPACE_NAME) --tag BuildId=$(modelbuildid) --query '[0]')
      [[ -z "$FOUND_MODEL" ]] && { echo "Model not found" ; exit 1; }
      echo $FOUND_MODEL >model.json
  name: 'getversion'
  displayName: "Determine if evaluation succeeded and new model is registered"
- publish: model.json
  artifact: model